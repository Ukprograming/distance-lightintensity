<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>USB距離×光グラフ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>距離 × 光強度 グラフ</h1>
  <button onclick="connectSerial()">シリアル接続</button>
  <h2>距離: <span id="distance">--</span> cm</h2>
  <h2>光強度: <span id="light">--</span> V</h2>
  <canvas id="scatterGraph" width="400" height="300"></canvas>

  <script>
    let port, reader;
    let scatterData = [];
    let chart;

    async function connectSerial() {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        const decoder = new TextDecoderStream();
        const inputDone = port.readable.pipeTo(decoder.writable);
        reader = decoder.readable.getReader();

        readLoop();
        alert("接続しました");
      } catch (err) {
        alert("接続失敗：" + err);
      }
    }

    async function readLoop() {
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        if (value) handleSerial(value.trim());
      }
    }

    function handleSerial(line) {
      const [distanceStr, lightStr] = line.split(",");
      const distance = parseFloat(distanceStr);
      const light = parseFloat(lightStr);
      document.getElementById("distance").textContent = distanceStr;
      document.getElementById("light").textContent = lightStr;

      if (!isNaN(distance) && !isNaN(light)) {
        scatterData.push({ x: distance, y: light });
        chart.update();
      }
    }

    window.onload = function () {
      const ctx = document.getElementById('scatterGraph').getContext('2d');
      chart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: '光強度 vs 距離',
            data: scatterData,
            pointRadius: 4,
            backgroundColor: 'blue'
          }]
        },
        options: {
          scales: {
            x: { title: { display: true, text: '距離 (cm)' } },
            y: { title: { display: true, text: '光強度 (V)' } }
          }
        }
      });
    };
  </script>
</body>
</html>
